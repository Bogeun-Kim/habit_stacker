{% extends 'habit_stacker/base.html' %}
{% block main_area %}
<div class="container mt-5">
    <h1 class="mb-4">인증 상세 페이지</h1>
    
    <div class="card mb-4">
        {% if authentication.file %}
            <img src="{{ authentication.file.url }}" class="card-img-top" alt="챌린지 이미지">
        {% else %}
            <div class="card-img-top bg-light text-center p-5">이미지 없음</div>
        {% endif %}
        <div class="card-body">
            {% if authentication.text %}
                <p class="card-text">{{ authentication.text }}</p>
            {% else %}
                <p class="card-text">인증 텍스트 없음</p>
            {% endif %}
            {% if user.id == authentication.user_id %}
                <a href="{% url 'edit_challenge' challenge.id %}" class="btn btn-primary">수정하기</a>
            {% endif %}
        </div>
    </div>

    <!-- 댓글 폼 -->
    <form id="comment-form" method="post" action="{% url 'add_comment' challenge_id=challenge.id user_id=authentication.user.id index=index %}">
        {% csrf_token %}
        <div class="form-group">
            <textarea name="comment" class="form-control" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">댓글 작성</button>
    </form>

    <!-- 댓글 목록 -->
    <div id="comments-list"></div>

    <script>
        console.log("{{ challenge.id }}")
        console.log("{{ authentication.user.id }}")
        console.log("{{ index }}")
        function loadComments() {
            fetch(`/get_comments/{{ challenge.id }}/{{ authentication.user.id }}/{{ index }}/`)
                .then(response => response.json())
                .then(data => {
                    let commentsList = document.getElementById('comments-list');
                    commentsList.innerHTML = '';
                    data.comments.forEach(comment => {
                        let newComment = document.createElement('div');
                        newComment.className = 'card mt-2';
                        newComment.innerHTML = `
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">${comment.comment_user}</h6>
                                <p class="card-text">${comment.text}</p>
                                <p class="card-text"><small class="text-muted">${comment.created_at}</small></p>
                            </div>
                        `;
                        commentsList.appendChild(newComment);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('댓글을 불러오는 중 오류가 발생했습니다.');
                });
        }

        // 페이지 로드 시 댓글 불러오기
        document.addEventListener('DOMContentLoaded', loadComments);

        document.getElementById('comment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            let form = this;
            let formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 댓글 추가 후 모든 댓글 다시 불러오기
                    loadComments();
                    
                    // 폼 초기화
                    form.reset();
                } else {
                    alert('댓글 작성에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('댓글 작성 중 오류가 발생했습니다.');
            });
        });
    </script>
</div>
{% endblock %}