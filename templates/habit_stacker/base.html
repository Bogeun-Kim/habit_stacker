<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Main</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="{% url 'main_page' %}">
                {% load static %}
                <img src="{% static 'logo_underbar.svg' %}" alt="Habit Stacker" style="width: 150px; height: auto;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarSupportedContent">
                <ul class="navbar-nav mb-2 mb-lg-0">
                    <!-- 여기에 추가 메뉴 항목을 넣을 수 있습니다 -->
                </ul>
                
                <!-- 검색창 (중앙 정렬) -->
                <form class="d-flex mx-auto">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" style="width: 300px;">
                    <button class="btn btn-outline-dark" type="submit">Search</button>
                </form>
                
                <div class="d-flex align-items-center">
                    <!-- 로그인/로그아웃 버튼 -->
                    {% if user.is_authenticated %}
                    <div class="dropdown">
                        <button class="btn btn-outline-dark dropdown-toggle" type="button" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <img class="profile" src="{% static 'profile.svg' %}" alt="Profile" style="width: 20px; height: auto;">
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                            <li><a class="dropdown-item" href="#">My page</a></li>
                            <li><a class="dropdown-item" href="{% url 'challenge_form' %}">Create</a></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
                        </ul>
                    </div>
                    {% else %}
                    <form class="d-flex me-2" action="{% url 'login' %}" method="GET">
                        <button class="btn btn-outline-dark" type="submit">
                            Log In
                        </button>
                    </form>
                    <form class="d-flex" action="{% url 'signup' %}" method="GET">
                        <button class="btn btn-outline-dark" type="submit">
                            Sign Up
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    {% block main_area %}
    {% endblock %}

    <!-- Footer-->
    <footer class="py-5 bg-dark">
        <div class="container"><p class="m-0 text-center text-white">Copyright &copy; Habit Stacker 2024</p></div>
    </footer>

    <!-- 챗봇 버튼 -->
    <div id="chatbot-button" class="position-fixed bottom-0 end-0 m-3">
        <button class="btn btn-primary rounded-circle" style="width: 60px; height: 60px;" onclick="toggleChatbot()">
            <i class="bi bi-chat-dots-fill"></i>
        </button>
    </div>

    <!-- 챗봇 창 -->
    <div id="chatbot-window" class="position-fixed bottom-0 end-0 m-3 bg-white border rounded shadow" style="width: 300px; height: 400px; display: none;">
        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <h5 class="m-0">챗봇</h5>
            <div>
                <button id="back-button" class="btn btn-sm btn-outline-secondary me-2" onclick="backToChallengeList()" style="display: none;">뒤로</button>
                <button class="btn-close" onclick="toggleChatbot()"></button>
            </div>
        </div>
        <div id="chatbot-content" class="p-2" style="height: calc(100% - 100px); overflow-y: auto;">
            <!-- 챌린지 리스트 또는 채팅 내용이 여기에 표시됩니다 -->
        </div>
        <div id="chatbot-input-area" class="p-2 border-top" style="display: none;">
            <form id="chatbot-form" onsubmit="sendChatbotMessage(event)">
                <div class="input-group">
                    <input type="text" id="chatbot-input" class="form-control" placeholder="챌린지 인증 메세지를 입력하거나 AI에게 도움을 요청해보세요!">
                    <button type="submit" class="btn btn-primary">전송</button>
                </div>
            </form>
            <form id="chatbot-image-form" enctype="multipart/form-data" onsubmit="sendChatbotImage(event)">
                <div class="input-group mt-2">
                    <label for="image-input" class="custom-file-upload" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; cursor: pointer;">챌린지 인증하기</label>
                    <input type="file" id="image-input" accept="image/*" style="display: none;">
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script>
    const userId = "{{ user.id }}";
    let selectedChallengeId = null;
    let isLoading = false; // 여기에 isLoading 변수를 추가합니다.

    function toggleChatbot() {
        var chatbotWindow = document.getElementById('chatbot-window');
        var chatbotButton = document.getElementById('chatbot-button');
        if (chatbotWindow.style.display === 'none') {
            chatbotWindow.style.display = 'block';
            chatbotButton.style.display = 'none';
            loadChallengeList();
        } else {
            chatbotWindow.style.display = 'none';
            chatbotButton.style.display = 'block';
        }
    }

    async function loadChallengeList() {
        const chatbotContent = document.getElementById('chatbot-content');
        chatbotContent.innerHTML = '<p>참여 중인 챌린지 목록을 불러오는 중...</p>';

        try {
            const response = await fetch(`/api/user/challenges/${userId}/`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const challenges = await response.json();

            chatbotContent.innerHTML = '<ul class="list-group">';
            challenges.forEach(challenge => {
                chatbotContent.innerHTML += `
                    <li class="list-group-item" style="cursor: pointer;" onclick="selectChallenge(${challenge.id})">
                        ${challenge.title}
                    </li>`;
            });
            chatbotContent.innerHTML += '</ul>';
        } catch (error) {
            console.error('챌린지 목록을 불러오는 중 오류 발생:', error);
            chatbotContent.innerHTML = '<p>챌린지 목록을 불러오는 데 실패했습니다.</p>';
        }
    }

    function selectChallenge(challengeId) {
        selectedChallengeId = challengeId;
        const chatbotContent = document.getElementById('chatbot-content');
        chatbotContent.innerHTML = '<p>채팅 내용을 불러오는 중...</p>';
        document.getElementById('chatbot-input-area').style.display = 'block';
        document.getElementById('back-button').style.display = 'inline-block';
        loadChatHistory(1);
    }

    async function loadChatHistory(page = 1) {
        if (!selectedChallengeId || isLoading) return;
        isLoading = true;
        const chatbotContent = document.getElementById('chatbot-content');
        console.log(selectedChallengeId); // 디버깅을 위해 추가

        try {
            const response = await fetch(`/api/challenge/${selectedChallengeId}/chat-history/${userId}/?page=${page}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            if (page === 1) {
                chatbotContent.innerHTML = '';
            }

            data.history.forEach(message => {
                const messageElement = createMessageElement(message);
                chatbotContent.appendChild(messageElement);
            });

            chatbotContent.scrollTop = chatbotContent.scrollHeight;
        } catch (error) {
            console.error('채팅 기록을 불러오는 중 오류 발생:', error);
            chatbotContent.innerHTML = '<p>채팅 기록을 불러오는 데 실패했습니다.</p>';
        } finally {
            isLoading = false;
        }
    }

    function createMessageElement(message) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${message.is_ai ? 'ai-message' : 'user-message'}`;
        
        const username = message.is_ai ? 'AI' : message.user;
        
        messageElement.innerHTML = `<strong>${username}:</strong> ${message.message}`;
        if (!message.is_ai && message.image_url) {
            messageElement.innerHTML += `<br><img src="${message.image_url}" alt="인증 이미지" style="max-width: 200px;">`;
        }
        
        return messageElement;
    }

    // 새로운 함수: 챌린지 리스트로 돌아가기
    function backToChallengeList() {
        selectedChallengeId = null;
        document.getElementById('chatbot-input-area').style.display = 'none';
        document.getElementById('back-button').style.display = 'none';
        loadChallengeList();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // challengeId 변수 설정 (Django 템플릿 변수 사용)
        const challengeId = "{{ challenge.id }}";
        const userId = "{{ user.id }}";
        const isAi = "{{ is_ai }}";
        let selectedImage = null;
        let currentPage = 1;
        let isLoading = false;

        async function loadChatHistory(page = 1) {
            if (isLoading) return;
            isLoading = true;
            try {
                const response = await fetch(`/api/challenge/${challengeId}/chat-history/${userId}/?page=${page}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const chatMessages = document.getElementById('chat-messages');

                if (page === 1) {
                    chatMessages.innerHTML = '';
                }

                data.history.forEach(message => {
                    const messageElement = createMessageElement(message);
                    if (page === 1) {
                        chatMessages.appendChild(messageElement);
                    } else {
                        chatMessages.insertBefore(messageElement, chatMessages.firstChild);
                    }
                });

                if (page === 1) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                currentPage = page;
            } catch (error) {
                console.error('채팅 기록을 불러오는 중 오류 발생:', error);
            } finally {
                isLoading = false;
            }
        }

        function createMessageElement(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.is_ai ? 'ai-message' : 'user-message'}`;
            
            const username = message.is_ai ? 'AI' : message.user;
            
            messageElement.innerHTML = `<strong>${username}:</strong> ${message.message}`;
            if (!message.is_ai && message.image_url) {
                messageElement.innerHTML += `<br><img src="${message.image_url}" alt="인증 이미지" style="max-width: 200px;">`;
            }
            
            return messageElement;
        }

        document.getElementById('chat-messages').addEventListener('scroll', function(e) {
            if (e.target.scrollTop === 0 && !isLoading) {
                loadChatHistory(currentPage + 1);
            }
        });

        sendMessage = async function() {
            var userInput = document.getElementById('user-input');
            var message = userInput.value.trim();
            var imageInput = document.getElementById('image-input');
            if (message || imageInput.files.length > 0) {
                var formData = new FormData();
                formData.append('challenge_id', challengeId);
                formData.append('message', message);
                if (imageInput.files.length > 0) {
                    formData.append('image', imageInput.files[0]);
                }

                try {
                    const response = await fetch('/api/challenge/chat/', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const messages = chunk.split('\n').filter(Boolean);

                        for (const message of messages) {
                            try {
                                const data = JSON.parse(message);
                                console.log("Received data:", data);  // 디버깅을 위한 로그
                                if (data.status === 'success') {
                                    addMessage(data.message);
                                } else {
                                    console.error('메시지 처리 실패:', data.error);
                                }
                            } catch (error) {
                                console.error('JSON 파싱 오류:', error, 'Raw message:', message);
                            }
                        }
                    }

                    // 입력 필드 초기화
                    userInput.value = '';
                    imageInput.value = '';

                } catch (error) {
                    console.error('에러:', error);
                }
            }
        };

        // 이벤트 리스너 설정
        const sendButton = document.getElementById('chatbot-input');
        if (sendButton) {
            sendButton.addEventListener('click', sendMessage);
        }

        const userInput = document.getElementById('btn btn-primary');
        if (userInput) {
            userInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }

        const imageInput = document.getElementById('btn btn-secondary');
        const customFileUpload = document.querySelector('chatbot-image-input');
        if (imageInput) {
            imageInput.addEventListener('change', function(event) {
                selectedImage = event.target.files[0];
                if (selectedImage) {
                    customFileUpload.textContent = '챌린지 인증';
                } else {
                    customFileUpload.textContent = '챌린지 인증';
                }
            });
        }

        function addMessage(message) {
            var chatMessages = document.getElementById('chat-messages');
            var messageElement = createMessageElement(message);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // CSRF 토큰을 가져오는 함수
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    })
</script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>