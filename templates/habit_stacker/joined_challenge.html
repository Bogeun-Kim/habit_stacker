{% extends 'habit_stacker/base.html' %}

{% block main_area %}

<style>
    .custom-row {
        display: flex;
        flex-wrap: wrap;
    }
    .col-lg-4-wider {
        width: 60%;
        padding-right: 15px;
    }
    .col-lg-8-narrower {
        width: 40%;
    }
    .img-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
    }
    .img-fluid {
        max-width: 100%;
        height: auto;
    }
    .image-container-article {
        width: 100%;
        max-width: 750px;
    }
    .nav-item {
        margin-bottom: 15px;
    }
    
    @media (max-width: 991px) {
        .col-lg-4-wider, .col-lg-8-narrower {
            width: 100%;
            padding-right: 0;
        }
        .image-container-article {
            max-width: 100%;
        }
    }
</style>
    <!-- Page content-->
    <div class="container px-4 px-lg-5 mt-5" style="padding-left: 0px; padding-right: 0px;">
        <div class="row">
            <div class="col-lg-4-wider">
                <!-- Post content-->
                <article class="image-container-article">
                    <!-- Preview image figure-->
                    <figure class="mb-4 img-container">
                        <img class="img-fluid rounded" src="https://dummyimage.com/700x467/ced4da/6c757d.jpg" alt="..." />
                    </figure>
                </article>
            </div>
            <div class="col-lg-8-narrower">
                <!-- Card Navigation -->
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">챌린지 소개</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="auth1-tab" data-bs-toggle="tab" data-bs-target="#auth1" type="button" role="tab" aria-controls="auth1" aria-selected="false">나의 인증 현황</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="auth2-tab" data-bs-toggle="tab" data-bs-target="#auth2" type="button" role="tab" aria-controls="auth2" aria-selected="false">참가자들의 인증 현황</button>
                            </li>
                        </ul>
                        <!-- Post content-->
                    <section class="mb-5">
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                                <h5 class="card-title fw-bolder">Overview Tab</h5>
                                <p class="card-text">기본정보 : {{ challenge.description }}</p>
                                <p class="card-text">카테고리 : {{ challenge.category }}</p>
                                <p class="card-text">start date : {{ challenge.created_at|date:"Y-m-d" }}</p>
                                <p class="card-text">인증샷 예시 : {{ challenge.image }}</p>
                                <p class="card-text">챌린지 진행 시 꼭 확인해주세요! : {{ challenge.note }}</p>
                            </div>

                            <div class="tab-pane fade" id="auth1" role="tabpanel" aria-labelledby="auth1-tab">
                                <h5 class="card-title fw-bolder">나의 인증 현황</h5>
                                <div id="my-authentication-images" class="row">
                                    <!-- 내 인증 사진들이 여기에 동적으로 추가됩니다 -->
                                </div>
                            </div>
                            <div class="tab-pane fade" id="auth2" role="tabpanel" aria-labelledby="auth2-tab">
                                <h5 class="card-title fw-bolder">Authentication Tab</h5>
                                <div id="authentication-images" class="row">
                                    <!-- 인증 사진들이 여기에 동적으로 추가됩니다 -->
                                </div>
                            </div>
                        </div>
                    </section>
                    </div>
                </div>
            </div>
        </div>
    </div> 

    <script>
        document.getElementById('join-btn')?.addEventListener('click', function() {
            var challengeId = this.getAttribute('data-challenge-id');
            if (confirm("챌린지에 참가하지 않은 사용자입니다. 참가하시겠습니까?")) {
                // 챌린지 참가 로직 (필요한 경우 API 호출 등을 추가)
                // 참가 후 인증 페이지로 이동
                window.location.href = "{% url 'join_challenge' challenge.id %}";
            } else {
                alert('참여를 취소했습니다.');
            }
        });

        document.getElementById('auth-btn')?.addEventListener('click', function() {
            var challengeId = this.getAttribute('data-challenge-id');
            // 인증 페이지로 이동하는 로직 수정
            window.location.href = "{% url 'join_challenge' challenge.id %}";
        });

        document.getElementById('login-btn')?.addEventListener('click', function() {
            alert('참여하려면 로그인해야 합니다.');
            window.location.href = "{% url 'login' %}";
        }); 

        function loadAuthenticationImages() {
            var challengeId = '{{ challenge.id }}';  // Django 템플릿 변수 사용
            fetch(`/api/challenge/${challengeId}/authentications/`)
        .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('authentication-images');
                    container.innerHTML = ''; // 기존 내용을 지웁니다.
                    
                    if (data.authentications && Array.isArray(data.authentications)) {
                        data.authentications.forEach(auth => {
                            if (auth.file_url) {
                                const imgElement = document.createElement('div');
                                imgElement.className = 'col-md-4 mb-3';
                                imgElement.innerHTML = `
                                    <div class="card">
                                        <img src="${auth.file_url}" class="card-img-top" alt="인증 이미지">
                                    <div class="card-body">
                                        <p class="card-text">${auth.user}: ${auth.text}</p>
                                        <p class="card-text"><small class="text-muted">${new Date(auth.created_at).toLocaleString()}</small></p>
                                        </div>
                                    </div>
                                `;
                                container.appendChild(imgElement);
                            }
                        });
                    } else {
                        console.error('Unexpected data structure:', data);
                        container.innerHTML = '<p>인증 내용을 불러오는 데 실패했습니다.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const container = document.getElementById('authentication-images');
                    container.innerHTML = '<p>인증 내용을 불러오는 중 오류가 발생했습니다.</p>';
                });
            }

        // 페이지 로드 시 인증 이미지를 불러옵니다
        document.addEventListener('DOMContentLoaded', function() {
            loadAuthenticationImages();
        });

        // 주기적으로 인증 이미지를 업데이트합니다
        setInterval(loadAuthenticationImages, 60000); // 1분마다 업데이트

        function loadMyAuthenticationImages() {
            var challengeId = '{{ challenge.id }}';  // Django 템플릿 변수 사용
            fetch(`/api/challenge/${challengeId}/my-authentications/`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('my-authentication-images');
                    container.innerHTML = ''; // 기존 내용을 지웁니다.
                    
                    if (data.authentications && Array.isArray(data.authentications)) {
                        if (data.authentications.length === 0) {
                            container.innerHTML = '<p>아직 인증한 이미지가 없습니다.</p>';
                        } else {
                            data.authentications.forEach(auth => {
                                if (auth.file_url) {
                                    const imgElement = document.createElement('div');
                                    imgElement.className = 'col-md-4 mb-3';
                                    imgElement.innerHTML = `
                                        <div class="card">
                                            <img src="${auth.file_url}" class="card-img-top" alt="인증 이미지">
                                            <div class="card-body">
                                                <p class="card-text">${auth.text}</p>
                                                <p class="card-text"><small class="text-muted">${new Date(auth.created_at).toLocaleString()}</small></p>
                                            </div>
                                        </div>
                                    `;
                                    container.appendChild(imgElement);
                                }
                            });
                        }
                    } else {
                        console.error('Unexpected data structure:', data);
                        container.innerHTML = '<p>인증 내용을 불러오는 데 실패했습니다.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const container = document.getElementById('my-authentication-images');
                    container.innerHTML = '<p>인증 내용을 불러오는 중 오류가 발생했습니다.</p>';
                });
        }

        // 페이지 로드 시 내 인증 이미지를 불러옵니다
        document.addEventListener('DOMContentLoaded', function() {
            loadMyAuthenticationImages();
        });

        // Authentication 탭이 클릭될 때 내 인증 이미지를 불러옵니다
        document.querySelector('button[data-bs-target="#auth1"]').addEventListener('click', loadMyAuthenticationImages);
    </script>

{% endblock %}