{% extends 'habit_stacker/base.html' %}

{% block main_area %}

<style>
    .custom-row {
        display: flex;
        flex-wrap: wrap;
    }
    .col-lg-4-wider {
        width: 60%;
        padding-right: 15px;
    }
    .col-lg-8-narrower {
        width: 40%;
    }
    .img-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
    }
    .img-fluid {
        max-width: 100%;
        height: auto;
    }
    .image-container-article {
        width: 100%;
        max-width: 750px;
    }
    .nav-item {
        margin-bottom: 15px;
    }

    footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;    
    }

    #main-container {
        padding: 10px 0 160px 0; /* top, right, bottom, left */
    }
    
    @media (max-width: 991px) {
        .col-lg-4-wider, .col-lg-8-narrower {
            width: 100%;
            padding-right: 0;
        }
        .image-container-article {
            max-width: 100%;
        }
    }
</style>
    <!-- Page content-->
    <div id="main-container" class="container px-4 px-lg-5 mt-5">
        <div class="row">
            <div class="col-lg-4-wider">
                <!-- Post content-->
                <article class="image-container-article">
                    <!-- Preview image figure-->
                    <figure class="mb-4 img-container">
                        {% if challenge.image %}
                            <img class="img-fluid rounded" src="{{ challenge.image.url }}" alt="..." />
                        {% else %}
                            <img class="img-fluid rounded" src="https://dummyimage.com/700x467/ced4da/6c757d.jpg" alt="..." />
                        {% endif %}
                    </figure>
                </article>
            </div>
            <div class="col-lg-8-narrower">
                <!-- Card Navigation -->
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">챌린지 소개</button>
                            </li>
                        </ul>
                        <!-- Post content-->
                    <section class="mb-5">
                        <div class="tab-content" id="myTabContent">
                            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                                <h5 class="card-title fw-bolder">Overview Tab</h5>
                                <p class="card-text">기본정보 : {{ challenge.description }}</p>
                                <p class="card-text">카테고리 : {{ challenge.category }}</p>
                                <p class="card-text">start date : {{ challenge.created_at|date:"Y-m-d" }}</p>
                                <p class="card-text">인증샷 예시 : </p>
                                {% if challenge.authentication_image %}
                                    <img class="img-fluid rounded" src="{{ challenge.authentication_image.url }}" style="width: auto; height: 200px;" alt="..."/>
                                {% else %}
                                    <img class="img-fluid rounded" src="https://dummyimage.com/300x200/dee2e6/6c757d.jpg" alt="..." />
                                {% endif %}
                                <p class="card-text">챌린지 진행 시 꼭 확인해주세요! : {{ challenge.note }}</p>
                                <button type="button" class="btn btn-primary" id="join-btn" data-challenge-id="{{ challenge.id }}">챌린지 참가</button>
                            </div>

                            {% comment %}
                            <div class="tab-pane fade" id="auth2" role="tabpanel" aria-labelledby="auth2-tab">
                                <h5 class="card-title fw-bolder">Authentication Tab</h5>
                                <div id="authentication-images" class="row">
                                    <!-- 인증 사진들이 여기에 동적으로 추가됩니다 -->
                                </div>
                            </div> {% endcomment %}
                        </div>
                    </section>
                    </div>
                </div>
            </div>
        <!-- 새로운 드롭다운 메뉴 추가 -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span id="currentSelection">다른 사람들의 인증 현황</span>
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" id="dropdown-item-authentication" href="#" data-value="others">다른 사람들의 인증 현황</a>
                        <a class="dropdown-item" id="dropdown-item-authentication" href="#" data-value="mine">나의 인증 현황</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 인증 이미지를 표시할 컨테이너 -->
        <div id="authenticationImagesContainer" class="row mt-3">
            <!-- 인증 이미지들이 여기에 동적으로 추가됩니다 -->
        </div>
    </div>
    <script>
        document.getElementById('join-btn')?.addEventListener('click', function() {
            var challengeId = this.getAttribute('data-challenge-id');
            if (confirm("챌린지에 참가하지 않은 사용자입니다. 참가하시겠습니까?")) {
                // 챌린지 참가 로직 (필요한 경우 API 호출 등을 추가)
                // 참가 후 인증 페이지로 이동
                window.location.href = "{% url 'join_challenge' challenge.id %}";
            } else {
                alert('참여를 취소했습니다.');
            }
        });

        document.getElementById('auth-btn')?.addEventListener('click', function() {
            var challengeId = this.getAttribute('data-challenge-id');
            // 인증 페이지로 이동하는 로직 수정
            window.location.href = "{% url 'join_challenge' challenge.id %}";
        });

        document.getElementById('login-btn')?.addEventListener('click', function() {
            alert('참여하려면 로그인해야 합니다.');
            window.location.href = "{% url 'login' %}";
        }); 

        // 드롭다운 메뉴 아이템 클릭 이벤트 처리
        document.querySelectorAll('[id^="dropdown-item-authentication"]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedValue = this.getAttribute('data-value');
                const buttonText = this.textContent;
                document.getElementById('currentSelection').textContent = buttonText;
                loadAuthenticationImages(selectedValue);
            });
        });

        // 페이지 로드 시 다른 사람들의 인증 이미지를 불러옵니다
        document.addEventListener('DOMContentLoaded', function() {
            loadAuthenticationImages('others');
        });

        function loadAuthenticationImages(type) {
            var challengeId = '{{ challenge.id }}';  // Django 템플릿 변수 사용

            var url = type === 'mine' ? `/api/challenge/${challengeId}/my-authentications/` : `/api/challenge/${challengeId}/authentications/`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('authenticationImagesContainer');
                    container.innerHTML = ''; // 기존 내용을 지웁니다.
                    
                    if (data.authentications && Array.isArray(data.authentications)) {
                        if (data.authentications.length === 0) {
                            container.innerHTML = '<p>인증된 이미지가 없습니다.</p>';
                        } else {
                            data.authentications.forEach((auth, index) => {
                                if (auth.file_url && auth.index !== undefined) {
                                    const imgElement = document.createElement('div');
                                    /* 한 행에 보여지는 이미지의 개수를 정함 */
                                    imgElement.className = 'col-md-3 mb-3';
                                    file_url = auth.file_url;
                                    redirect_url = '{% url "authenticate_challenge" challenge_id=challenge.id user_id=0 index=0 %}'.replace('0', auth.user_id).replace('0', auth.index);
                                    imgElement.innerHTML = `
                                        <div class="card">
                                            <img src="${file_url}" class="card-img-top" alt="인증 이미지" onclick="window.location.href='${redirect_url}'" style="width: auto%; height: 200px;">
                                            <div class="card-body">
                                                <p class="card-text">${ auth.user + ': ' + auth.text}</p>
                                                <p class="card-text"><small class="text-muted">${new Date(auth.created_at).toLocaleString()}</small></p>
                                            </div>
                                        </div>
                                    `;
                                    container.appendChild(imgElement);
                                }
                            });
                            
                            if (container.children.length === 0) {
                                container.innerHTML = '<p>인증된 이미지가 없습니다.</p>';
                            }
                        }
                    } else {
                        console.error('Unexpected data structure:', data);
                        container.innerHTML = '<p>인증 내용을 불러오는 데 실패했습니다.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const container = document.getElementById('authenticationImagesContainer');
                    container.innerHTML = '<p>인증 내용을 불러오는 중 오류가 발생했습니다.</p>';
                });
        }
        // 페이지 로드 시 다른 사람들의 인증 이미지를 불러옵니다
        document.addEventListener('DOMContentLoaded', function() {
            loadAuthenticationImages('others');
        });
    </script>

{% endblock %}